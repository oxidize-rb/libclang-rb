---
name: CI

on:
  - push

jobs:
  build-gem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1"
      - run: rake
      - uses: actions/upload-artifact@v2
        with:
          name: gem
          path: pkg/

  github-runners:
    needs: build-gem
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            ruby-version: "3.1"
            ruby-platform: "x86_64-linux"
          - os: windows-latest
            ruby-version: "3.1"
            ruby-platform: "x64-mingw32"
          - os: macos-latest
            ruby-version: "3.1"
            ruby-platform: "x86_64-darwin"
    steps:
      - uses: actions/checkout@v3

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}

      - uses: actions/download-artifact@v2
        with:
          name: gem
          path: pkg/

      - name: Gem install
        run: gem install pkg/*.gem

      - name: Test
        run: ruby test/*.rb

  qemu:
    needs: build-gem
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ruby-platform: "x86_64-linux"
            docker-platform: "linux/amd64"
            base-image: "ruby:3.1"
          - ruby-platform: "aarch64-linux"
            docker-platform: "linux/arm64"
            base-image: "ruby:3.1"
          - ruby-platform: "x86_64-linux-musl"
            docker-platform: "linux/amd64"
            base-image: "ruby:3.1-alpine"
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v2
        with:
          name: gem
          path: pkg/*-${{ matrix.ruby-platform }}.gem

      - uses: docker/setup-qemu-action@v1
        with:
          platforms: ${{ matrix.docker-platform }}

      - run: |
          docker buildx create --use --name test-${{ matrix.ruby-platform }}
          docker run --platform ${{ matrix.docker-platform }} -v $PWD:/src -w /src ${{ matrix.base-image }} bash -c "gem install pkg/*-${{ matrix.ruby-platform }}.gem && ruby test/*.rb"
